/* 
 lithe 
 @author xiaojue [designsor@gmail.com] 
 @fileoverview a javascript common loader 
 @vserion 0.3.1 
 */
!function(a,b){function c(a,b){return b=b||K,b?b.getElementsByTagName(a):b}function d(){}function e(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function f(a){return"[object String]"===N.call(a)}function g(a){return"[object Function]"===N.call(a)}function h(a){var b={};return Q(a,function(a){b[a]=1}),T(b)}function i(a,b){return a.getAttribute(b)}function j(a){var b=[];return a.replace(O,"").replace(P,function(a,c){b.push(c)}),h(b)}function k(a,c){var d=a(c.require,c.exports,c);d!==b&&(c.exports=d)}function l(){this.map={}}function m(a){for(var b=a.slice(a.lastIndexOf("?")+1).split("&"),c=0;c<b.length;c++){var d=b[c].split("="),e=d[0],f=d[1];if("timestamp"==e)return f}return null}function n(a){return a.indexOf("://")>0||0===a.indexOf("//")}function o(a){return!q(a)}function p(a){var b=a.match(/[^?]*(?=\/.*$)/);return(b?b[0]:".")+"/"}function q(a){return a.slice(a.lastIndexOf("/")+1).replace(/\?.*$/,"")}function r(a){var b=/([^:\/])\/\/+/g;if(b.lastIndex=0,b.test(a)&&(a=a.replace(b,"$1/")),-1===a.indexOf("."))return a;for(var c,d=a.split("/"),e=[],f=0;f<d.length;f++)if(c=d[f],".."===c){if(0===e.length)throw new Error("The path is invalid: "+a);e.pop()}else"."!==c&&e.push(c);return e.join("/")}function s(a,b){a=r(a);var c=a.charAt(a.length-1);return"/"===c?a:("#"===c?a=a.slice(0,-1):-1!==a.indexOf("?")||/\.(?:js|css)$/.test(a)||(a+=".js"),a.indexOf(":80/")>0&&(a=a.replace(":80/","/")),b&&(a=a.replace(/\?.+$/,"")),a)}function t(a){var b,c,d,e,f,g={},h=hb.directorys;for(b=0;b<h.length&&!g[a];b++){e=h[b];for(f in e)if(c=e[f],d=new RegExp("^"+f+"/"),d.test(a)&&!g[a]){a=a.replace(d,c),g[a]=!0;break}}return a}function u(a){var b=hb.alias;if(b){var c=b[a];return c?c:t(a)}return a}function v(a,b){if(b=p(b||kb.basepath),n(a))return a;hb.init&&(a=u(a));var c="";return 0===a.indexOf("./")||0===a.indexOf("../")?(0===a.indexOf("./")&&(a=a.substring(2)),c=b+a):c="/"===a.charAt(0)&&"/"!==a.charAt(1)?b+a.substring(1):b+"/"+a,s(c)}function w(a,b){U.trigger("fetch",[a,b])}function x(a,c,d){var e=y("script",d);e.onload=e.onerror=e.onreadystatechange=function(){/loaded|complete|undefined/.test(e.readyState)&&(e.onload=e.onerror=e.onreadystatechange=null,e.parentNode&&!_&&e.parentNode.removeChild(e),e=b,g(c)&&c())},e.async="async";var f=bb?bb:ab;a=f?a+"?timestamp="+f:a,e.src=a,z(e)}function y(a,b){var c=K.createElement(a);return b&&(c.charset=b),c}function z(a){var b=c("base",V)[0];b?V.insertBefore(a,b):V.appendChild(a)}function A(a){var b=a.id,c=R(a.dependencies,function(a){jb.push(b);var c=B(kb.cache[v(a)]);return c&&jb.push(b),jb.pop(),!c});return D(c)}function B(a){if(!a||a.status!==ib.save)return!1;jb.push(a.id);var b=a.dependencies;if(b.length){if(C(b,jb))return!0;for(var c=0;c<b.length;c++)if(B(kb.cache[v(b[c])]))return!0}return jb.pop(),!1}function C(a,b){var c=a.concat(b);return c.length>h(c).length}function D(a){return f(a)&&(a=[a]),S(a,function(a){return v(a)})}function E(a,b){function c(a){(a||{}).status<ib.ready&&(a.status=ib.ready),--f,0===f&&b()}a=D(a),U.trigger("start",[a]);var d=R(a,function(a){return a&&(!kb.cache[a]||kb.cache[a].status<ib.ready)}),e=d.length;if(0===e)return b(),void 0;var f=e;Q(d,function(a){function b(a){if(U.trigger("fetchsuccess",[d,a]),d.status>=ib.save){var b=A(d);b.length?E(b,function(){c(d)}):c(d)}else a?c(d):c()}var d=kb.get(a);d.status<ib.save?w(a,b):b()})}function F(){Q(gb,function(a){var b=kb.get(a.id);b._save(a)}),gb=[]}function G(a,b){E(a,function(){a=D(a);var c=S(a,function(a){return a?kb.get(a)._compile():null});g(b)&&b.apply(null,c),U.trigger("end")})}function H(a){hb=a,hb.directorys=[];var b,c,d,e=hb.alias;if(e)for(b in e)c=e[b],o(c)&&(d={},d[b]=c,hb.directorys.push(d));hb.init=!0,hb.basepath&&(kb.basepath=hb.basepath),kb.config=hb,bb=hb.timestamp}function I(a){this.id=a,this.status=0,this.dependencies=[],this.exports=null,this.parent=[],this.factory=d}var J=!(typeof window===b||!a.navigator||!a.document);if(J){{var K=a.document,L=Array.prototype,M=Object,N=M.prototype.toString,O=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,P=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,Q=L.forEach?function(a,b){a.forEach(b)}:function(a,b){for(var c=0;c<a.length;c++)b(a[c],c,a)},R=L.filter?function(a,b){return a.filter(b)}:function(a,b){var c=[];return Q(a,function(a,d,e){b(a,d,e)&&c.push(a)}),c},S=L.map?function(a,b){return a.map(b)}:function(a,b){var c=[];return Q(a,function(a,d,e){c.push(b(a,d,e))}),c},T=M.keys?M.keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};L.indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1}}e(l.prototype,{trigger:function(a,b){var c=this.map[a];c&&Q(c,function(a){a.apply(this,b)})},on:function(a,b){this.map[a]?this.map[a].push(b):this.map[a]=[b]}});var U=new l,V=K.head||c("head")[0]||K.documentElement,W="utf-8",X=c("script"),Y=X[X.length-1],Z=i(Y,"data-path")||Y.src||i(Y,"src"),$=i(Y,"data-config"),_="true"===i(Y,"data-debug"),ab=m(Y.src),bb=null,cb=i(Y,"data-main"),db={},eb={},fb={};U.on("fetch",function(a,b){if(!/\.css$/.test(a)){if(fb[a])return b(),void 0;if(db[a])return eb[a].push(b),void 0;db[a]=!0,eb[a]=[b],x(a,function(){fb[a]=!0,delete db[a];var b=eb[a];b&&(delete eb[a],Q(b,function(a){a()}))},W)}});var gb=[],hb={},ib={created:0,save:1,ready:2,compiling:3,compiled:4},jb=[];e(I.prototype,{_compile:function(){function a(a){a=s(v(a),!0);var c=kb.cache[a];return c?c.status===ib.compiling?c.exports:(c.parent=b,c._compile()):null}var b=this;if(b.status===ib.compiled)return b.exports;if(b.status<ib.save)return null;b.status=ib.compiling,a.cache=kb.cache,b.require=a,b.exports={};var c=b.factory;return g(c)&&k(c,b),b.status=ib.compiled,kb.events.trigger("compiled",[b]),b.exports},_save:function(a){this.status<ib.save&&(this.id=a.id,this.name=a.name,this.dependencies=a.deps,this.factory=a.factory,this.status=ib.save)}});var kb=e({basepath:Z,events:U,cache:{},get:function(a){return a=s(a,!0),kb.cache[a]||(kb.cache[a]=new I(a))},define:function(a,b){var c=j(b.toString()),d={id:v(a),name:a,deps:c,factory:b};gb.push(d),F()},use:function(a,b){!$||hb.init?G(a,b):function(){G($,function(c){H(c),G(a,b)})}()}});$&&($=D($)),a.lithe=kb,a.define=kb.define,cb&&setTimeout(function(){a.lithe.use(cb)})}else exports.tool=require("./lib/lithe-tool.js"),exports.hfs=require("./lib/lithe-hfs.js")}(this);